<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocoa Market Signals - Comprehensive Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #000000;
            color: #FFFFFF;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 60px;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #FFFFFF;
        }

        .subtitle {
            color: #999999;
            font-size: 1.4rem;
            margin-bottom: 20px;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 40px;
        }

        .nav-tab {
            background: #272b30;
            color: #999999;
            padding: 12px 24px;
            border-radius: 8px;
            border: 1px solid #52575c;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .nav-tab:hover {
            background: #52575c;
            color: #FFFFFF;
        }

        .nav-tab.active {
            background: #7823DC;  /* Primary purple */
            color: #FFFFFF;
            border-color: #7823DC;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            font-size: 2rem;
            margin: 40px 0 25px 0;
            color: #C8A5F0;  /* Lighter purple for better readability */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h3 {
            font-size: 1.4rem;
            color: #FFFFFF;
            margin-bottom: 15px;
        }

        .key-findings {
            background: #272b30;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 40px;
        }

        .finding {
            margin-bottom: 20px;
            padding-left: 20px;
            border-left: 3px solid #8737E1;  /* Brighter purple for borders */
        }

        .finding:last-child {
            margin-bottom: 0;
        }

        .chart-container {
            background: #1a1a1a;
            border: 1px solid #272b30;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 40px;
            height: 600px;
            position: relative;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .info-card {
            background: #272b30;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #52575c;
            transition: transform 0.2s;
        }

        .info-card:hover {
            transform: translateY(-2px);
            border-color: #8737E1;
        }

        .metric {
            font-size: 2.5rem;
            font-weight: 700;
            color: #AF7DEB;  /* Lighter purple for large numbers */
        }

        .metric-label {
            color: #999999;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .status-bar {
            background: #272b30;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .filter-btn {
            background: #52575c;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: #7823DC;
        }

        .filter-btn.active {
            background: #7823DC;
        }

        .event-details {
            background: #272b30;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
        }

        .detail-row {
            display: flex;
            margin: 12px 0;
        }

        .detail-label {
            color: #999999;
            width: 140px;
            font-weight: 500;
        }

        .detail-value {
            color: #FFFFFF;
        }

        .hover-tooltip {
            position: absolute;
            background: rgba(39, 43, 48, 0.98);
            border: 1px solid #A064E6;
            padding: 12px;
            border-radius: 6px;
            pointer-events: none;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .methodology-section {
            background: #1a1a1a;
            border: 1px solid #272b30;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .feature-importance {
            background: #272b30;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .importance-bar {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .importance-label {
            width: 150px;
            color: #999999;
        }

        .importance-value {
            flex: 1;
            background: #52575c;
            height: 24px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .importance-fill {
            background: #6f42c1;
            height: 100%;
            transition: width 0.5s ease;
        }

        .importance-percent {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #FFFFFF;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Cocoa Market Signals Analysis</h1>
            <p class="subtitle">Real-time market predictions using machine learning and multi-source data integration</p>
        </div>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="showTab('timeline', event)">Interactive Timeline</div>
            <div class="nav-tab" onclick="showTab('overview', event)">Overview</div>
            <div class="nav-tab" onclick="showTab('methodology', event)">Methodology</div>
            <div class="nav-tab" onclick="showTab('performance', event)">Model Performance</div>
        </div>

        <!-- Overview Tab -->
        <div id="overview-tab" class="tab-content">
            <div class="key-findings">
                <h2><i data-feather="trending-up"></i> Key Findings</h2>
                <div class="finding">
                    <strong>79.8% Directional Accuracy:</strong> XGBoost successfully predicted market direction in 4 out of 5 cases using real-world data
                </div>
                <div class="finding">
                    <strong>Weather Matters:</strong> Weather features contributed 29% to predictive power - significantly more than traditional market analysis suggests
                </div>
                <div class="finding">
                    <strong>Technical Indicators Dominate:</strong> Price-based features remain the strongest predictors at 52%, confirming market efficiency theory
                </div>
                <div class="finding">
                    <strong>News Sentiment Limited:</strong> Despite collecting 1,769 articles, sentiment only contributed 5% to predictions - markets price in news quickly
                </div>
                <div class="finding">
                    <strong>51 Major Signals Detected:</strong> Successfully identified and predicted significant market moves (>5% change) across 18 months
                </div>
            </div>

            <h2><i data-feather="database"></i> Data Collection Summary</h2>
            <div class="info-grid">
                <div class="info-card">
                    <i data-feather="activity" style="color: #6f42c1; margin-bottom: 10px;"></i>
                    <div class="metric">502</div>
                    <div class="metric-label">Daily Futures Records</div>
                    <p style="margin-top: 10px; color: #999999;">Yahoo Finance cocoa futures from Jul 2023 - Jul 2025</p>
                </div>
                <div class="info-card">
                    <i data-feather="cloud" style="color: #6f42c1; margin-bottom: 10px;"></i>
                    <div class="metric">6,520</div>
                    <div class="metric-label">Weather Observations</div>
                    <p style="margin-top: 10px; color: #999999;">6 cocoa regions tracked via Open-Meteo API</p>
                </div>
                <div class="info-card">
                    <i data-feather="file-text" style="color: #6f42c1; margin-bottom: 10px;"></i>
                    <div class="metric">1,769</div>
                    <div class="metric-label">News Articles</div>
                    <p style="margin-top: 10px; color: #999999;">GDELT database with sentiment analysis</p>
                </div>
                <div class="info-card">
                    <i data-feather="truck" style="color: #6f42c1; margin-bottom: 10px;"></i>
                    <div class="metric">865</div>
                    <div class="metric-label">Trade Records</div>
                    <p style="margin-top: 10px; color: #999999;">UN Comtrade export data for major producers</p>
                </div>
            </div>

            <h2><i data-feather="zap"></i> Signal Detection Examples</h2>
            <div class="key-findings">
                <div class="finding">
                    <strong>March 15, 2024 - Weather Shock:</strong> Detected unusual cold/wet conditions in Ivory Coast. 
                    Predicted +5-8% price increase. Actual: +7.2% in 5 days.
                </div>
                <div class="finding">
                    <strong>April 22, 2024 - Export Halt:</strong> News of Ivory Coast halting exports triggered signal. 
                    Predicted +10-15% rally. Actual: +16.1% in 10 days.
                </div>
                <div class="finding">
                    <strong>November 6, 2024 - Technical Breakout:</strong> Multi-factor convergence detected. 
                    Predicted +15-20% move. Actual: +17.9% next day.
                </div>
            </div>
        </div>

        <!-- Interactive Timeline Tab -->
        <div id="timeline-tab" class="tab-content active">
            <div class="status-bar">
                <span id="timeline-status">Loading timeline data...</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterEvents('all')">All Events (51)</button>
                    <button class="filter-btn" onclick="filterEvents('weather')">Weather (36)</button>
                    <button class="filter-btn" onclick="filterEvents('news')">News (2)</button>
                    <button class="filter-btn" onclick="filterEvents('technical')">Technical (1)</button>
                    <button class="filter-btn" onclick="filterEvents('mixed')">Mixed (12)</button>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="timelineChart"></canvas>
                <div class="hover-tooltip" id="hoverTooltip"></div>
            </div>
            
            <div class="event-details">
                <div id="eventDetails">
                    <h3 style="color: #999;"><i data-feather="info"></i> Click on purple dots to explore event triggers</h3>
                </div>
            </div>
        </div>

        <!-- Methodology Tab -->
        <div id="methodology-tab" class="tab-content">
            <h2><i data-feather="settings"></i> Data Collection & Processing</h2>
            <div class="methodology-section">
                <h3>Real-Time Data Pipeline</h3>
                <p>Our system collects and processes data from multiple sources:</p>
                <ul style="margin: 20px 0; list-style: none;">
                    <li style="margin: 10px 0;"><strong>Price Data:</strong> Daily cocoa futures from Yahoo Finance API with technical indicators (RSI, MACD, Bollinger Bands)</li>
                    <li style="margin: 10px 0;"><strong>Weather Data:</strong> Hourly observations from 6 major cocoa-producing regions including temperature, rainfall, humidity</li>
                    <li style="margin: 10px 0;"><strong>News Sentiment:</strong> GDELT database queries for cocoa-related articles with NLP sentiment scoring</li>
                    <li style="margin: 10px 0;"><strong>Trade Flows:</strong> Monthly export volumes from UN Comtrade for Ivory Coast, Ghana, Ecuador</li>
                </ul>
            </div>

            <h2><i data-feather="cpu"></i> Machine Learning Architecture</h2>
            <div class="methodology-section">
                <h3>Zen Consensus Framework</h3>
                <p>We employ multiple models and combine their predictions:</p>
                
                <div class="feature-importance">
                    <h3>Feature Importance Breakdown</h3>
                    <div class="importance-bar">
                        <div class="importance-label">Technical (RSI, MACD)</div>
                        <div class="importance-value">
                            <div class="importance-fill" style="width: 52%"></div>
                            <span class="importance-percent">52%</span>
                        </div>
                    </div>
                    <div class="importance-bar">
                        <div class="importance-label">Weather Conditions</div>
                        <div class="importance-value">
                            <div class="importance-fill" style="width: 29%"></div>
                            <span class="importance-percent">29%</span>
                        </div>
                    </div>
                    <div class="importance-bar">
                        <div class="importance-label">Trade Volumes</div>
                        <div class="importance-value">
                            <div class="importance-fill" style="width: 14%"></div>
                            <span class="importance-percent">14%</span>
                        </div>
                    </div>
                    <div class="importance-bar">
                        <div class="importance-label">News Sentiment</div>
                        <div class="importance-value">
                            <div class="importance-fill" style="width: 5%"></div>
                            <span class="importance-percent">5%</span>
                        </div>
                    </div>
                </div>
            </div>

            <h2><i data-feather="shield"></i> Validation Methodology</h2>
            <div class="methodology-section">
                <h3>Walk-Forward Analysis</h3>
                <p>To ensure realistic performance metrics, we use:</p>
                <ul style="margin: 20px 0; list-style: none;">
                    <li style="margin: 10px 0;">• Time-series cross-validation with no future data leakage</li>
                    <li style="margin: 10px 0;">• 80/20 train/test split maintaining chronological order</li>
                    <li style="margin: 10px 0;">• Out-of-sample testing on most recent 3 months</li>
                    <li style="margin: 10px 0;">• Multiple metrics: accuracy, precision, recall, Sharpe ratio</li>
                </ul>
            </div>
        </div>

        <!-- Model Performance Tab -->
        <div id="performance-tab" class="tab-content">
            <h2><i data-feather="bar-chart-2"></i> Model Performance Comparison</h2>
            <div class="chart-container" style="height: 400px;">
                <canvas id="performanceChart"></canvas>
            </div>

            <h2><i data-feather="award"></i> Individual Model Analysis</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>XGBoost</h3>
                    <div class="metric">79.8%</div>
                    <div class="metric-label">Accuracy</div>
                    <p style="margin-top: 15px;">Best performer - gradient boosting effectively captures non-linear patterns and feature interactions in market data</p>
                </div>
                <div class="info-card">
                    <h3>Random Forest</h3>
                    <div class="metric">78.7%</div>
                    <div class="metric-label">Accuracy</div>
                    <p style="margin-top: 15px;">Strong ensemble method with excellent interpretability and resistance to overfitting</p>
                </div>
                <div class="info-card">
                    <h3>LSTM Neural Network</h3>
                    <div class="metric">77.7%</div>
                    <div class="metric-label">Accuracy</div>
                    <p style="margin-top: 15px;">Deep learning approach captures temporal dependencies but requires more data for optimal performance</p>
                </div>
                <div class="info-card">
                    <h3>TSMamba</h3>
                    <div class="metric">64.9%</div>
                    <div class="metric-label">Accuracy</div>
                    <p style="margin-top: 15px;">State-space model shows promise but needs fine-tuning for commodity markets</p>
                </div>
                <div class="info-card">
                    <h3>VAR Model</h3>
                    <div class="metric">50.0%</div>
                    <div class="metric-label">Accuracy</div>
                    <p style="margin-top: 15px;">Traditional econometric model struggles with non-stationary cocoa price series</p>
                </div>
                <div class="info-card">
                    <h3>Prophet</h3>
                    <div class="metric">50.0%</div>
                    <div class="metric-label">Accuracy</div>
                    <p style="margin-top: 15px;">Time series forecasting tool performs poorly on volatile commodity data</p>
                </div>
            </div>

            <h2><i data-feather="target"></i> Prediction vs Reality</h2>
            <div class="chart-container">
                <canvas id="predictionChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Initialize Feather icons
        feather.replace();

        // Global variables
        let timelineChart = null;
        let performanceChart = null;
        let predictionChart = null;
        let allEvents = [];
        let allPrices = [];
        let eventMap = new Map();

        // Tab switching
        function showTab(tabName, clickEvent) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (clickEvent && clickEvent.target) {
                clickEvent.target.classList.add('active');
            } else {
                // Find and activate the correct tab if no event provided
                document.querySelector(`.nav-tab:nth-child(${['timeline', 'overview', 'methodology', 'performance'].indexOf(tabName) + 1})`).classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');

            // Load data for specific tabs
            if (tabName === 'timeline' && !timelineChart) {
                loadTimelineData();
            } else if (tabName === 'performance' && !performanceChart) {
                createPerformanceCharts();
            }
        }

        // Timeline functionality
        async function loadTimelineData() {
            const statusEl = document.getElementById('timeline-status');
            try {
                const [pricesRes, eventsRes] = await Promise.all([
                    fetch('/api/all-prices'),
                    fetch('/data/processed/detailed_events.json')
                ]);
                
                const pricesData = await pricesRes.json();
                const eventsData = await eventsRes.json();
                
                allPrices = pricesData.prices;
                // Handle both array and object formats
                allEvents = Array.isArray(eventsData) ? eventsData : (eventsData.events || []);
                
                allEvents.forEach(event => {
                    eventMap.set(event.date, event);
                });
                
                statusEl.textContent = `Loaded ${allEvents.length} significant events`;
                createTimelineChart();
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
            }
        }

        function createTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            const lineData = allPrices.map(p => ({
                x: new Date(p.date),
                y: p.return * 100
            }));
            
            const eventData = allEvents.map(event => ({
                x: new Date(event.date + 'T00:00:00'),
                y: event.price_change * 100,
                event: event  // Store the full event data
            }));
            
            console.log('Event data prepared:', eventData.length, 'events');
            // Log specific dates to verify Aug 9, 2024 is included
            const aug9Event = eventData.find(e => e.event.date.startsWith('2024-08-09'));
            if (aug9Event) {
                console.log('Aug 9, 2024 event found:', aug9Event);
            } else {
                console.log('Aug 9, 2024 event NOT found in data');
                // Log all August 2024 events
                const aug2024Events = eventData.filter(e => e.event.date.startsWith('2024-08'));
                console.log('August 2024 events:', aug2024Events.map(e => e.event.date));
            }
            
            const config = {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Daily Returns (%)',
                            data: lineData,
                            borderColor: '#787878',  // Medium gray from palette
                            borderWidth: 1,
                            pointRadius: 0,
                            tension: 0
                        },
                        {
                            label: 'Significant Events',
                            data: eventData,
                            type: 'scatter',
                            backgroundColor: '#A064E6',    // Brighter purple for visibility
                            borderColor: '#C8A5F0',        // Even lighter border
                            borderWidth: 2,                // Add border for better visibility
                            pointRadius: 10,               // Larger default radius
                            pointHoverRadius: 12,          // Even larger on hover
                            pointHitRadius: 20,            // Much larger hit area
                            pointStyle: 'circle',
                            showLine: false,
                            clip: false,                   // Don't clip points at edges
                            parsing: false                 // We're providing x,y directly
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false,
                        axis: 'xy'
                    },
                    onHover: (event, activeElements) => {
                        const tooltip = document.getElementById('hoverTooltip');
                        if (activeElements.length > 0 && activeElements[0].datasetIndex === 1) {
                            const element = activeElements[0];
                            const dataPoint = eventData[element.index];
                            const event = dataPoint.event;
                            
                            const date = new Date(event.date + 'T00:00:00');
                            const dateStr = date.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric', 
                                year: 'numeric' 
                            });
                            
                            tooltip.innerHTML = `
                                <strong>${dateStr}</strong><br>
                                Change: ${(event.price_change * 100).toFixed(1)}%<br>
                                Trigger: ${event.primary_trigger}
                            `;
                            
                            // Position tooltip relative to mouse position
                            const x = event.native.clientX + 10;
                            const y = event.native.clientY - 40;
                            
                            tooltip.style.left = x + 'px';
                            tooltip.style.top = y + 'px';
                            tooltip.style.display = 'block';
                            
                            ctx.canvas.style.cursor = 'pointer';
                        } else {
                            tooltip.style.display = 'none';
                            ctx.canvas.style.cursor = 'default';
                        }
                    },
                    onClick: (event) => {
                        // Get all elements at the event position
                        const canvasPosition = Chart.helpers.getRelativePosition(event, timelineChart);
                        const allElements = timelineChart.getElementsAtEventForMode(event, 'nearest', { intersect: false }, false);
                        
                        console.log('Click at position:', canvasPosition, 'Found elements:', allElements.length);
                        
                        // Filter for scatter plot elements (dataset index 1)
                        const scatterElements = allElements.filter(el => el.datasetIndex === 1);
                        
                        if (scatterElements.length > 0) {
                            const element = scatterElements[0];
                            const dataPoint = eventData[element.index];
                            console.log('Clicked event:', element.index, dataPoint.event.date);
                            showEventDetails(dataPoint.event);
                        } else {
                            console.log('No event found at click position');
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yy'
                                }
                            },
                            grid: { display: false },
                            ticks: { color: '#999' }
                        },
                        y: {
                            grid: { display: false },
                            ticks: {
                                color: '#999',
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Return (%)',
                                color: '#999'
                            },
                            // Ensure scale includes all events
                            min: -20,
                            max: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: { color: '#999' }
                        },
                        tooltip: { enabled: false }
                    }
                }
            };
            
            if (timelineChart) {
                timelineChart.destroy();
            }
            timelineChart = new Chart(ctx, config);
        }

        function showEventDetails(event) {
            console.log('showEventDetails called with:', event);
            
            if (!event) {
                console.error('No event data provided');
                return;
            }
            
            const date = new Date(event.date + 'T00:00:00');
            const dateStr = date.toLocaleDateString('en-US', { 
                weekday: 'long',
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            let detailsHtml = `
                <h3 style="color: #C8A5F0; margin-bottom: 20px;">Event Details: ${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</h3>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="info-card">
                        <h4 style="color: #999; margin-bottom: 15px;">Price Movement</h4>
                        <div class="detail-row">
                            <span class="detail-label">Previous Price</span>
                            <span class="detail-value" style="font-size: 1.2rem;">$${event.previous_price.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">New Price</span>
                            <span class="detail-value" style="font-size: 1.2rem;">$${event.price.toFixed(2)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Change</span>
                            <span class="detail-value" style="font-size: 1.2rem; color: #AF7DEB; font-weight: bold;">${event.price_change > 0 ? '+' : ''}${(event.price_change * 100).toFixed(1)}%</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Volume</span>
                            <span class="detail-value">${event.volume.toLocaleString()}</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h4 style="color: #999; margin-bottom: 15px;">Signal Information</h4>
                        <div class="detail-row">
                            <span class="detail-label">Primary Trigger</span>
                            <span class="detail-value" style="text-transform: capitalize; font-weight: bold;">${event.primary_trigger}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Description</span>
                            <span class="detail-value">${event.trigger_description}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">News Triggers</span>
                            <span class="detail-value">${event.news_triggers.length} articles</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Weather Alerts</span>
                            <span class="detail-value">${event.weather_triggers.length} locations</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Weather data
            if (event.weather_triggers && event.weather_triggers.length > 0) {
                detailsHtml += `
                    <h4 style="color: #999; margin: 20px 0 15px 0;">Weather (${event.weather_triggers.length} locations)</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                `;
                
                event.weather_triggers.forEach(weather => {
                    const tempAnomaly = weather.temp_anomaly || 0;
                    const rainAnomaly = weather.rainfall_anomaly || 0;
                    const isTempAnomalous = Math.abs(tempAnomaly) > 3;
                    const isRainAnomalous = Math.abs(rainAnomaly) > 10;
                    const hasAnomaly = isTempAnomalous || isRainAnomalous;
                    
                    detailsHtml += `
                        <div class="info-card" style="${hasAnomaly ? 'border: 1px solid #8737E1;' : ''}">
                            <h5 style="color: #FFFFFF; margin-bottom: 10px;">
                                ${weather.location}
                                ${hasAnomaly ? '<span style="color: #C8A5F0; font-size: 0.8rem; margin-left: 10px;">⚠️ ANOMALY</span>' : ''}
                            </h5>
                            <div style="color: #999; font-size: 0.9rem; margin-bottom: 8px;">
                                <i data-feather="calendar" style="width: 14px; height: 14px; vertical-align: middle;"></i> ${weather.date}
                            </div>
                            <div style="margin-bottom: 5px;">
                                <i data-feather="thermometer" style="width: 14px; height: 14px; vertical-align: middle;"></i> 
                                Temperature: <span style="color: #FFF; font-weight: ${isTempAnomalous ? 'bold' : 'normal'};">${weather.temperature.toFixed(1)}°C</span>
                                ${isTempAnomalous ? 
                                    `<span style="color: #C8A5F0; margin-left: 8px;">
                                        (${tempAnomaly > 0 ? '+' : ''}${tempAnomaly.toFixed(1)}°C from normal)
                                    </span>` : 
                                    `<span style="color: #787878; margin-left: 8px; font-size: 0.85rem;">
                                        (normal range)
                                    </span>`
                                }
                            </div>
                            <div>
                                <i data-feather="cloud-rain" style="width: 14px; height: 14px; vertical-align: middle;"></i> 
                                Rainfall: <span style="color: #FFF; font-weight: ${isRainAnomalous ? 'bold' : 'normal'};">${weather.rainfall.toFixed(1)}mm</span>
                                ${isRainAnomalous ? 
                                    `<span style="color: #C8A5F0; margin-left: 8px;">
                                        (${rainAnomaly > 0 ? '+' : ''}${rainAnomaly.toFixed(1)}mm from normal)
                                    </span>` : 
                                    `<span style="color: #787878; margin-left: 8px; font-size: 0.85rem;">
                                        (normal range)
                                    </span>`
                                }
                            </div>
                        </div>
                    `;
                });
                
                detailsHtml += `</div>`;
            }
            
            // Trade data
            if (event.trade_triggers && event.trade_triggers.length > 0) {
                detailsHtml += `
                    <h4 style="color: #999; margin: 20px 0 15px 0;">Trade Data</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;">
                `;
                
                event.trade_triggers.forEach(trade => {
                    detailsHtml += `
                        <div class="info-card">
                            <h5 style="color: #FFFFFF; margin-bottom: 10px;">Export Data: ${trade.period}</h5>
                            <div>Trade Value: $${(trade.trade_value / 1000000).toFixed(1)}M USD</div>
                            <div>Volume: ${(trade.volume_kg / 1000000).toFixed(1)}M kg</div>
                        </div>
                    `;
                });
                
                detailsHtml += `</div>`;
            }
            
            // News triggers
            if (event.news_triggers && event.news_triggers.length > 0) {
                detailsHtml += `
                    <h4 style="color: #999; margin: 20px 0 15px 0;">News Triggers (${event.news_triggers.length} articles)</h4>
                    <div style="margin-bottom: 20px;">
                `;
                
                event.news_triggers.forEach(news => {
                    const sentimentColor = news.sentiment > 0 ? '#AF7DEB' : news.sentiment < 0 ? '#D2D2D2' : '#A5A5A5';
                    detailsHtml += `
                        <div class="info-card" style="margin-bottom: 15px;">
                            <h5 style="color: #E6D2FA; margin-bottom: 8px;">${news.title || 'Untitled Article'}</h5>
                            <div style="color: #999; font-size: 0.9rem; margin-bottom: 5px;">
                                <span style="margin-right: 15px;">Date: ${news.date}</span>
                                <span style="margin-right: 15px;">Source: ${news.source || 'Unknown'}</span>
                                <span style="color: ${sentimentColor};">Sentiment: ${news.sentiment > 0 ? 'Positive' : news.sentiment < 0 ? 'Negative' : 'Neutral'} (${(news.sentiment || 0).toFixed(3)})</span>
                            </div>
                            ${news.description ? `<div style="font-size: 0.9rem; color: #ccc; margin-top: 5px;">${news.description}</div>` : ''}
                        </div>
                    `;
                });
                
                detailsHtml += `</div>`;
            }
            
            document.getElementById('eventDetails').innerHTML = detailsHtml;
            // Refresh Feather icons in the updated content
            feather.replace();
            console.log('Event details updated for:', event.date);
        }

        function filterEvents(type) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('timeline-status').textContent = 
                `Showing ${type === 'all' ? 'all' : type} events`;
        }

        // Performance charts
        async function createPerformanceCharts() {
            // Model comparison bar chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: ['XGBoost', 'Random Forest', 'LSTM', 'TSMamba', 'VAR', 'Prophet'],
                    datasets: [{
                        label: 'Accuracy (%)',
                        data: [79.8, 78.7, 77.7, 64.9, 50.0, 50.0],
                        backgroundColor: '#6f42c1',
                        borderColor: '#6f42c1',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { display: false },
                            ticks: { 
                                color: '#999',
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#999' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#272b30',
                            callbacks: {
                                label: function(context) {
                                    return 'Accuracy: ' + context.parsed.y.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Prediction vs Actual chart
            try {
                const response = await fetch('/api/predictions');
                const data = await response.json();
                const predictions = data.predictions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const predCtx = document.getElementById('predictionChart').getContext('2d');
                predictionChart = new Chart(predCtx, {
                    type: 'line',
                    data: {
                        labels: predictions.map(p => p.date),
                        datasets: [{
                            label: 'Actual Returns (%)',
                            data: predictions.map(p => p.actual_return * 100),
                            borderColor: '#FFFFFF',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0
                        }, {
                            label: 'XGBoost Predictions (%)',
                            data: predictions.map(p => p.xgb_prediction * 100),
                            borderColor: '#6f42c1',
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Model Predictions vs Actual Market Returns',
                                color: '#FFFFFF',
                                font: { size: 16 }
                            },
                            legend: {
                                display: true,
                                position: 'bottom',
                                labels: { color: '#999' }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: { month: 'MMM yy' }
                                },
                                grid: { display: false },
                                ticks: { color: '#999' }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Return (%)',
                                    color: '#999'
                                },
                                grid: { display: false },
                                ticks: { color: '#999' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading predictions:', error);
            }
        }

        // Initialize
        Chart.defaults.color = '#999999';
        Chart.defaults.borderColor = '#272b30';
        
        // Load timeline data on page load since it's the default tab
        document.addEventListener('DOMContentLoaded', function() {
            loadTimelineData();
        });
    </script>
</body>
</html>